cmake_minimum_required(VERSION 3.10)
project(mqtt_demo C)

# 1. è‡ªåŠ¨æ£€æµ‹æ¶æ„ï¼ˆé»˜è®¤æœ¬åœ°ç¼–è¯‘ï¼‰
if(NOT DEFINED TOOLCHAIN)
    set(TOOLCHAIN "native")
    message(STATUS "ğŸ–¥ï¸  æœ¬åœ°ç¼–è¯‘æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰")
else()
    message(STATUS "ğŸ”§ äº¤å‰ç¼–è¯‘æ¨¡å¼ï¼š${TOOLCHAIN}")
endif()

# 2. è®¾ç½®ç¼–è¯‘äº§ç‰©ç›®å½•
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/build/${TOOLCHAIN}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/build/${TOOLCHAIN}/lib)
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_SOURCE_DIR}/build/${TOOLCHAIN}/bin)

# 3. å®šä¹‰pahoç¼–è¯‘è„šæœ¬ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰
function(build_paho_mqtt)
    # é¿å…é‡å¤ç¼–è¯‘
    if(EXISTS ${CMAKE_SOURCE_DIR}/build/${TOOLCHAIN}/lib/libpaho-mqtt3a.a)
        return()
    endif()

    message(STATUS "â³ é¦–æ¬¡ç¼–è¯‘ paho.mqtt.c...")
   execute_process(
        COMMAND ${CMAKE_SOURCE_DIR}/cmake/build-paho.cmake
        ${CMAKE_SOURCE_DIR} ${TOOLCHAIN} ${CROSS_COMPILE}
        RESULT_VARIABLE PAHO_RESULT
    )
    
    if(NOT PAHO_RESULT EQUAL 0)
        message(FATAL_ERROR "paho.mqtt.c ç¼–è¯‘å¤±è´¥ï¼")
    endif()
endfunction()

# 4. ç¼–è¯‘pahoï¼ˆä»…å¼€å‘ç¯å¢ƒéœ€è¦ï¼‰
if(NOT DEFINED ENV{STAGING_DIR})
    build_paho_mqtt()
    set(PAHO_DIR ${CMAKE_SOURCE_DIR}/build/${TOOLCHAIN})
else()
    # Buildrootæ¨¡å¼ï¼šç›´æ¥å¼•ç”¨stagingç›®å½•
    set(PAHO_DIR $ENV{STAGING_DIR}/usr)
endif()


# ä½¿ç”¨ GLOB_RECURSE è‡ªåŠ¨æŸ¥æ‰¾ï¼ˆæ–¹ä¾¿ä½†éœ€å°å¿ƒï¼‰
# è‡ªåŠ¨é€’å½’æŸ¥æ‰¾ src ä¸‹æ‰€æœ‰ .c æ–‡ä»¶ï¼š
file(GLOB_RECURSE SRC_FILES src/*.c)
add_executable(mqtt_demo ${SRC_FILES})

# 5. ä½ çš„åº”ç”¨
# add_executable(mqtt_demo src/main.c)

# 6. åŒ…å«è·¯å¾„å’Œé“¾æ¥
target_include_directories(mqtt_demo PRIVATE 
    ${PAHO_DIR}/include
    ${CMAKE_SOURCE_DIR}/vendor/paho.mqtt.c/src  # æºç è°ƒè¯•ç”¨
)

target_link_libraries(mqtt_demo PRIVATE
    ${PAHO_DIR}/lib/libpaho-mqtt3a.a
    pthread
)

# 7. æœ¬åœ°æµ‹è¯•ä¾¿æ·ç›®æ ‡
if(TOOLCHAIN STREQUAL "native")
    add_custom_target(run
        COMMAND ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/mqtt_demo
        DEPENDS mqtt_demo
        WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    )
    
    add_custom_target(clean-all
        COMMAND rm -rf ${CMAKE_SOURCE_DIR}/build
    )
endif()